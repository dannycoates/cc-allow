#!/bin/bash
set -e

REPO="dannycoates/cc-allow"
BIN_DIR="${CLAUDE_PLUGIN_ROOT}/bin"

# Detect platform
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
case $ARCH in
  x86_64) ARCH="amd64" ;;
  aarch64|arm64) ARCH="arm64" ;;
esac

CC_ALLOW_PATH="${BIN_DIR}/cc-allow"

# Already installed - fast exit
if [ -x "$CC_ALLOW_PATH" ]; then
  exit 0
fi

mkdir -p "$BIN_DIR"

# Get download URL from latest release
RELEASE_URL="https://api.github.com/repos/${REPO}/releases/latest"
DOWNLOAD_URL=$(curl -sL "$RELEASE_URL" | grep "browser_download_url.*${OS}_${ARCH}" | cut -d'"' -f4)

# Download and extract
curl -sL "$DOWNLOAD_URL" | tar -xz -C "$BIN_DIR"
chmod +x "$CC_ALLOW_PATH"

# Initialize project config if it doesn't exist
"$CC_ALLOW_PATH" --init

#!/bin/bash
set -e

REPO="dannycoates/cc-allow"
PLUGIN_ROOT="${CLAUDE_PLUGIN_ROOT:-$(dirname "$(dirname "$0")")}"
BIN_DIR="${PLUGIN_ROOT}/bin"

# Detect platform
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
case $ARCH in
  x86_64) ARCH="amd64" ;;
  aarch64|arm64) ARCH="arm64" ;;
esac

CC_ALLOW_BIN="${BIN_DIR}/cc-allow"
PROJECT_DIR="${CLAUDE_PROJECT_DIR:-.}"

if [ -n "$CLAUDE_ENV_FILE" ]; then
  printf 'export CC_ALLOW_BIN="%b"\n' $CC_ALLOW_BIN >> "$CLAUDE_ENV_FILE"
fi

# Download if not already installed
if [ ! -x "$CC_ALLOW_BIN" ]; then
  mkdir -p "$BIN_DIR"

  # Get download URL from latest release
  RELEASE_URL="https://api.github.com/repos/${REPO}/releases/latest"
  DOWNLOAD_URL=$(curl -sL "$RELEASE_URL" | grep "browser_download_url.*${OS}_${ARCH}" | cut -d'"' -f4)

  # Download and extract
  curl -sL "$DOWNLOAD_URL" | tar -xz -C "$BIN_DIR"
  chmod +x "$CC_ALLOW_BIN"
fi

# Initialize project config (pipe hook JSON so --init can check source)
mkdir -p "$PROJECT_DIR/.config/cc-allow"
"$CC_ALLOW_BIN" --init --hook

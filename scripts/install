#!/bin/bash
set -e

REPO="dannycoates/cc-allow"
VERSION="latest"
CACHE_DIR="${HOME}/.cache/cc-allow"

# Detect platform
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)
case $ARCH in
  x86_64) ARCH="amd64" ;;
  aarch64|arm64) ARCH="arm64" ;;
esac

CC_ALLOW_PATH="${CACHE_DIR}/cc-allow"
CC_FMT_PATH="${CACHE_DIR}/cc-fmt"

# Already installed - fast exit
if [ -x "$CC_ALLOW_PATH" ] && [ -x "$CC_FMT_PATH" ]; then
  exit 0
fi

mkdir -p "$CACHE_DIR"

# Get download URL from latest release
RELEASE_URL="https://api.github.com/repos/${REPO}/releases/latest"
DOWNLOAD_URL=$(curl -sL "$RELEASE_URL" | grep "browser_download_url.*${OS}_${ARCH}" | cut -d'"' -f4)

# Download and extract (archive contains both cc-allow and cc-fmt)
curl -sL "$DOWNLOAD_URL" | tar -xz -C "$CACHE_DIR"
chmod +x "$CC_ALLOW_PATH" "$CC_FMT_PATH"

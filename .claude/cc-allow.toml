# cc-allow config for development projects
# Sensible defaults: allow dev tools, block dangerous operations

version = "1.0"

[policy]
default = "ask"                    # defer to Claude Code's permission system
dynamic_commands = "deny"           # block $VAR or $(cmd) as command names
default_message = "Command not allowed by project policy"

# ============================================================================
# PATH ALIASES
# ============================================================================
# Define reusable path patterns to reduce repetition

[paths]
project = "path:$PROJECT_ROOT/**"
plugin = "path:$CLAUDE_PLUGIN_ROOT/**"
tmp = "path:/tmp/**"
safe-write = ["path:$PROJECT_ROOT/**", "path:/tmp/**", "path:/dev/null"]
sensitive-read = ["path:$HOME/.ssh/**", "path:**/*.key", "path:**/*.pem"]
sensitive-write = [
    "path:$HOME/.*",
    "path:/etc/**",
    "path:/usr/**",
    "path:/bin/**",
    "path:/sbin/**",
    "path:/var/**",
]

# ============================================================================
# FILE PERMISSIONS (Read, Edit, Write)
# ============================================================================
# Control Claude Code's Read, Edit, and Write file tools.
# Also controls bash commands that access files and redirects.
# Evaluation order: deny -> allow -> default (deny always wins)

[files]
default = "ask"  # defer to Claude Code when no rules match

[files.read]
allow = ["alias:project", "alias:plugin"]
deny = ["alias:sensitive-read"]
deny_message = "Cannot read {{.FileName}} - sensitive file"

[files.edit]
allow = ["alias:project"]
deny = ["path:$HOME/.*"]
deny_message = "Cannot edit {{.FileName}} - sensitive file"

# Also applies to output redirects (>, >>) when redirects.respect_file_rules = true
[files.write]
allow = ["alias:safe-write"]
deny = ["alias:sensitive-write"]
deny_message = "Cannot write to {{.FilePath}} - system directory"

# ============================================================================
# REDIRECTS
# ============================================================================

[redirects]
respect_file_rules = true

# ============================================================================
# ALLOWED COMMANDS
# ============================================================================

[allow]
commands = [
    # Plugin/Skill Binaries
    "path:$CLAUDE_PLUGIN_ROOT/**",

    # File & Directory Navigation
    "ls", "dir", "vdir", "pwd", "tree", "file", "stat",
    "basename", "dirname", "realpath", "readlink",
    # File Viewing & Reading
    "cat", "tac", "head", "tail", "less", "more", "nl",
    "od", "hexdump", "xxd",
    # Text Processing & Transformation
    "grep", "egrep", "fgrep", "sed", "awk", "gawk",
    "cut", "paste", "join", "sort", "uniq", "shuf",
    "tr", "rev", "expand", "unexpand", "fold", "fmt", "column", "pr",
    "wc", "comm", "diff", "cmp", "colordiff", "delta", "iconv", "strings",
    # Searching & Finding
    "find", "fd", "locate", "mlocate", "plocate",
    "which", "whereis", "type", "xargs",
    "rg", "ripgrep", "ag", "fzf",
    # File Operations (Non-Destructive)
    "cp", "mv", "touch", "mkdir", "ln", "install",
    # Archive & Compression
    "tar", "gzip", "gunzip", "zcat", "bzip2", "bunzip2", "bzcat",
    "xz", "unxz", "xzcat", "zstd", "unzstd", "zstdcat",
    "zip", "unzip", "7z", "7za", "7zr", "rar", "unrar",
    # Printing & Output
    "echo", "printf", "yes", "seq", "tee",
    # Date, Time & Calculation
    "date", "cal", "ncal", "time", "bc", "dc", "expr", "factor",
    # User & System Info (Read-Only)
    "whoami", "id", "groups", "who", "w", "users", "last", "lastlog", "finger",
    "uname", "hostname", "hostnamectl", "uptime", "arch", "nproc",
    "lscpu", "lsmem", "free", "df", "du", "lsblk", "lsusb", "lspci", "lsof", "dmesg",
    # Process inspection (read-only)
    "ps", "top", "htop", "pgrep", "pidof", "pstree", "jobs", "nice", "renice",
    # Network inspection (read-only)
    "ping", "ping6", "traceroute", "tracepath", "mtr",
    "dig", "nslookup", "host", "whois",
    "ip", "ifconfig", "ss", "netstat", "nc", "netcat", "nmap", "tcpdump",
    # Shell Builtins & Utilities
    "test", "[", "[[", "true", "false", "sleep", "env", "printenv",
    # Version Control
    "git", "gh", "hg", "svn", "fossil",
    # Go development
    "go", "gofmt", "golint", "gopls",
    # Build tools
    "make", "just", "cargo", "npm", "yarn", "pnpm", "bun",
    # Editors & viewers
    "vim", "nvim", "nano", "code",
    # Misc Utilities
    "man", "info", "help", "apropos", "whatis", "tldr",
    "watch", "timeout", "strace", "ltrace",
    "md5sum", "sha1sum", "sha256sum", "sha512sum", "base64",
    "nix", "nix-env", "nix-shell", "wc",
    # Project binaries
    "path:$PROJECT_ROOT/cc-allow", "path:$PROJECT_ROOT/print-ast", "cc-query", "path:/tmp/cc-allow-test",
    # Remove commands (handled by rules below)
    "rm", "rmdir", "chmod",
]

# ============================================================================
# DENIED COMMANDS
# ============================================================================

[deny]
commands = [
    "sudo", "su", "doas",           # privilege escalation
    "dd", "mkfs", "fdisk", "parted", # disk operations
    "shutdown", "reboot", "halt",   # system control
    "killall", "pkill",             # mass process killing
]
message = "{{.Command}} blocked - dangerous system command"

# ============================================================================
# SHELL CONSTRUCTS
# ============================================================================

[constructs]
function_definitions = "deny"       # prevent command shadowing
background = "ask"                 # allow but defer to Claude Code
subshells = "ask"

# ============================================================================
# SPECIFIC RULES - Deny rules
# ============================================================================

# Block recursive rm
[[deny.rm]]
message = "{{.ArgsStr}} - recursive deletion not allowed"
args.any_match = ["flags:r", "--recursive"]

# Block curl/wget/fetch - use WebFetch tool instead
[[deny.curl]]
message = "{{.Command}} blocked - use WebFetch tool instead"

[[deny.wget]]
message = "{{.Command}} blocked - use WebFetch tool instead"

[[deny.fetch]]
message = "{{.Command}} blocked - use WebFetch tool instead"

# Block dangerous git operations
[[deny.git.push]]
message = "{{.ArgsStr}} - force push not allowed"
args.any_match = ["--force", "flags:f"]

[[deny.git.reset]]
message = "{{.ArgsStr}} - hard reset not allowed"
args.contains = ["--hard"]

# Block cd to anywhere except /tmp and project root
[[deny.cd]]
message = "cd {{.Arg 0}} - only /tmp and project directories allowed"

# ============================================================================
# SPECIFIC RULES - Allow rules
# ============================================================================

# Allow cd only to /tmp and project root
[[allow.cd]]
args.any_match = ["alias:tmp", "alias:project"]

# cc-allow Kitchen Sink Configuration
# This example demonstrates ALL configuration features documented in docs/config.md
# Use this as a reference — don't use it directly as it's intentionally comprehensive

version = "1.0"

# =============================================================================
# POLICY
# =============================================================================

[policy]
default = "ask"                    # "allow", "deny", or "ask" for unmatched commands
dynamic_commands = "deny"          # action for $VAR or $(cmd) as command name
default_message = "Command requires approval"
unresolved_commands = "ask"        # "ask" or "deny" for commands not found in PATH
respect_file_rules = true          # check file rules for command arguments (default: true)
# allowed_paths = ["/usr/bin", "/bin", "/usr/local/bin"]  # optional: restrict command search

# =============================================================================
# ALLOW/DENY COMMAND LISTS
# =============================================================================

[allow]
commands = [
    # Simple command names
    "ls", "cat", "head", "tail", "grep", "find", "wc", "echo", "pwd", "date",
    "git", "go", "npm", "cargo",

    # Path patterns for location-based matching
    "path:$PROJECT_ROOT/bin/*",        # project-local binaries
    "path:$PROJECT_ROOT/scripts/*",    # project scripts
    "path:/usr/local/bin/*",           # user-installed tools
]

[deny]
commands = [
    # Dangerous system commands
    "sudo", "su", "doas",
    "dd", "mkfs", "fdisk", "parted",
    "shutdown", "reboot", "halt",

    # Commands from untrusted locations
    "path:/tmp/**",                    # deny anything from /tmp
    "path:$HOME/Downloads/**",         # deny from Downloads
]
message = "Dangerous or untrusted command blocked"

# =============================================================================
# CONSTRUCTS
# =============================================================================

[constructs]
function_definitions = "deny"      # foo() { ... } — prevent function definitions
background = "deny"                # command & — prevent backgrounding
subshells = "ask"                  # (command) — ask for subshells
heredocs = "allow"                 # <<EOF ... EOF — allow heredocs (checked by [[heredoc]] rules)

# =============================================================================
# RULES — Basic Argument Matching
# =============================================================================

# --- contains: all listed strings must be present ---
[[deny.rm]]
message = "{{.ArgsStr}} — recursive force deletion blocked"
args.contains = ["-rf"]                 # must have exactly "-rf"

# --- any_match: at least one pattern must match ---
[[deny.chmod]]
message = "Cannot set world-writable permissions"
args.any_match = ["777", "666", "re:[0-7][67][67]"]

# --- all_match: every argument must match one of these ---
[[allow.touch]]
args.all_match = ["path:$PROJECT_ROOT/**"]  # only allow touching project files

# --- position: specific argument positions must match ---
[[deny.mv]]
message = "Cannot move files to system directories"
args.position = { "1" = "path:/etc/**" }    # destination is /etc

# =============================================================================
# RULES — Extended Argument Matching
# =============================================================================

# --- Position with enum values (OR semantics) ---
# Using positional nesting for common git subcommands
[[allow.git.status]]
[[allow.git.diff]]
[[allow.git.log]]
[[allow.git.branch]]
[[allow.git.show]]
[[allow.git.blame]]

# Deny network git operations
[[deny.git.push]]
message = "{{.Arg 0}} — network git operations require approval"

[[deny.git.pull]]
message = "{{.Arg 0}} — network git operations require approval"

[[deny.git.fetch]]
message = "{{.Arg 0}} — network git operations require approval"

[[deny.git.clone]]
message = "{{.Arg 0}} — network git operations require approval"

[[allow.docker]]
message = "Safe docker inspection"
# Multi-position enum: subcommand AND flag must both match
args.position = {
    "0" = ["ps", "images", "inspect", "logs", "stats"],
    "1" = ["--format", "-f", "--filter", "--tail", "--help", "-h"]
}

[[deny.docker]]
message = "Destructive docker operations blocked"
args.position = { "0" = ["rm", "rmi", "kill", "stop", "prune", "system prune"] }

# --- any_match with sequence objects (adjacent argument matching) ---
[[allow.ffmpeg]]
message = "ffmpeg with safe input source"
args.any_match = [
    # Sequence: -i followed by $HOME path
    { "0" = "-i", "1" = "path:$HOME/**" },
    # Sequence: -i followed by project path
    { "0" = "-i", "1" = "path:$PROJECT_ROOT/**" },
    # String pattern: help flag
    "re:^-(-help|h)$"
]

[[deny.ffmpeg]]
message = "ffmpeg cannot read from system directories"
args.any_match = [
    { "0" = "-i", "1" = "path:/etc/**" },
    { "0" = "-i", "1" = "path:/sys/**" },
    { "0" = "-i", "1" = "path:/proc/**" }
]

# --- all_match with sequences (multiple required pairs) ---
[[allow.openssl]]
message = "openssl with proper certificate handling"
args.all_match = [
    # Must have -in with cert file
    { "0" = "-in", "1" = ["path:*.pem", "path:*.crt", "path:*.key", "path:*.der"] },
    # AND must have -out with cert file
    { "0" = "-out", "1" = ["path:*.pem", "path:*.crt", "path:*.der"] }
]

# --- 3-position sequence ---
[[allow.rsync]]
message = "rsync with safe flags"
args.any_match = [
    { "0" = "-a", "1" = "-v", "2" = "--progress" },
    { "0" = "-avz", "1" = "--progress" }
]

# =============================================================================
# RULES — Pipe Context
# =============================================================================

# Block shells receiving piped input from download commands
[[deny.bash]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} — piping to shell blocked"
pipe.from = ["curl", "wget", "nc", "netcat"]

[[deny.sh]]
message = "sh cannot receive piped input from network tools"
pipe.from = ["curl", "wget", "nc", "netcat"]

# Block eval from receiving ANY piped input
[[deny.eval]]
message = "eval cannot receive piped input"
pipe.from = ["path:*"]

# Block curl from piping to dangerous sinks
[[deny.curl]]
message = "curl cannot pipe to shell or eval"
pipe.to = ["bash", "sh", "zsh", "eval", "source"]

# =============================================================================
# RULES — Pattern Types
# =============================================================================

# --- path: patterns ---
[[deny.cat]]
message = "Cannot read key files"
args.any_match = ["path:**/*.key", "path:**/*.pem", "path:**/.env*"]

# --- re: regex patterns ---
[[deny.grep]]
message = "Cannot search for sensitive patterns"
args.any_match = ["re:(?i)(password|secret|token|api.?key)"]

# --- path: patterns with variable expansion ---
[[allow.rm]]
message = "rm allowed in project directory"
args.any_match = ["path:$PROJECT_ROOT/**"]

[[deny.rm]]
message = "Cannot delete files outside project — {{.ArgsStr}}"

# --- flags: patterns ---
[[deny.tar]]
message = "tar extract blocked (use explicit extraction)"
args.any_match = ["flags:x", "flags:xf", "flags:xzf", "flags:xjf"]

[[allow.tar]]
message = "tar create/list allowed"
args.any_match = ["flags:c", "flags:t", "flags:cf", "flags:tf"]

[[deny.chmod]]
message = "Cannot add execute permission"
args.any_match = ["flags[+]:x"]          # matches +x, +rx, +rwx

# --- Negation ---
[[allow.find]]
# Allow find only in project root (negated: NOT outside project)
args.any_match = ["path:$PROJECT_ROOT/**"]
# Alternative with negation: args.any_match = ["!path:/etc/**", "!path:/usr/**"]

# =============================================================================
# RULES — Per-Rule File Configuration
# =============================================================================

# Disable file rule checking for tar (complex argument patterns)
[[allow.tar]]
respect_file_rules = false

# Force specific access type for custom command
[[allow.mybackup]]
file_access_type = "Read"          # check all file args against Read rules

# =============================================================================
# RULES — Positional File Rules
# =============================================================================

# cp: source is Read, destination is Write
[[allow.cp]]
args.position = { "0" = "rule:read", "1" = "rule:write" }

# mv: same pattern as cp
[[allow.mv]]
args.position = { "0" = "rule:read", "1" = "rule:write" }

# install: source is Read, destination is Write
[[allow.install]]
args.position = { "0" = "rule:read", "1" = "rule:write" }

# =============================================================================
# REDIRECTS
# =============================================================================

[redirects]
respect_file_rules = true          # check file rules for redirect targets

# Allow redirects to safe locations
[[redirect]]
action = "allow"
[redirect.to]
exact = ["/dev/null", "/dev/stderr", "/dev/stdout"]

[[redirect]]
action = "allow"
[redirect.to]
pattern = ["path:$PROJECT_ROOT/**", "path:/tmp/**"]

# Deny redirects to system directories
[[redirect]]
action = "deny"
message = "Cannot redirect to {{.Target}} — system directory"
[redirect.to]
pattern = ["path:/etc/**", "path:/usr/**", "path:/bin/**", "path:/sbin/**"]

# Deny appending to shell config files
[[redirect]]
action = "deny"
message = "Cannot append to shell config: {{.TargetFileName}}"
append = true                      # only match >> (append mode)
[redirect.to]
exact = [".bashrc", ".zshrc", ".profile", ".bash_profile"]
pattern = ["path:*/.bashrc", "path:*/.zshrc", "path:*/.profile"]

# =============================================================================
# HEREDOCS
# =============================================================================

# Deny heredocs with dangerous content patterns
[[heredoc]]
action = "deny"
message = "Heredoc contains dangerous SQL"
content_match = ["re:(?i)DROP\\s+TABLE", "re:(?i)DELETE\\s+FROM", "re:(?i)TRUNCATE"]

[[heredoc]]
action = "deny"
message = "Heredoc contains shell injection patterns"
content_match = [
    "re:\\$\\(.*\\)",              # command substitution
    "re:`.*`",                      # backtick execution
    "re:rm\\s+-rf",                 # recursive delete
    "re:/dev/tcp/",                 # bash network
]

[[heredoc]]
action = "deny"
message = "Heredoc contains privilege escalation"
content_match = ["re:(?m)^\\s*(sudo|su)\\s"]

# =============================================================================
# FILE TOOL PERMISSIONS
# =============================================================================

[files]
default = "ask"                    # when no rules match

[files.read]
allow = [
    "path:$PROJECT_ROOT/**",
    "path:$HOME/Documents/**",
    "path:$HOME/code/**",
    "path:/tmp/**",
    "path:**/*.md",                # markdown anywhere
    "path:**/*.txt",               # text files anywhere
]
deny = [
    # Sensitive directories
    "path:$HOME/.ssh/**",
    "path:$HOME/.gnupg/**",
    "path:$HOME/.aws/**",
    "path:/etc/shadow",
    "path:/etc/sudoers",
    "/secrets/**",

    # Sensitive file patterns
    "path:**/*.key",
    "path:**/*.pem",
    "path:**/.env*",
    "path:**/*credentials*",
    "path:**/*password*",
    "re:.*\\.(key|pem|p12|pfx)$",
]
deny_message = "Cannot read {{.FilePath}} — sensitive file"

[files.edit]
allow = [
    "path:$PROJECT_ROOT/**",
]
deny = [
    "path:$HOME/.*",               # dotfiles
    "path:**/.env*",
    "path:**/*.key",
]
deny_message = "Cannot edit {{.FileName}} in {{.FileDir}}"

[files.write]
allow = [
    "path:$PROJECT_ROOT/**",
    "path:/tmp/**",
]
deny = [
    # System directories
    "path:/etc/**",
    "path:/usr/**",
    "path:/bin/**",
    "path:/sbin/**",
    "path:/var/**",
    "/protected/**",

    # Home sensitive areas
    "path:$HOME/.ssh/**",
    "path:$HOME/.gnupg/**",
    "path:$HOME/.*",               # dotfiles

    # Sensitive patterns
    "path:**/*.key",
    "path:**/*.pem",
]
deny_message = "Cannot write to {{.FilePath}} — {{.FileDir}} is protected"

# =============================================================================
# MESSAGE TEMPLATES — Examples
# =============================================================================

# Templates are shown in context above, here are more examples:

# Show full command with all arguments
# message = "{{.ArgsStr}} — not allowed"

# Show specific positional argument
# message = "Cannot {{.Arg 0}} to {{.Arg 1}}"

# Show resolved path
# message = "{{.ResolvedPath}} — untrusted location"

# Show pipe context
# message = "{{.Command}} receiving from {{index .PipesFrom 0}}"

# Redirect context
# message = "Cannot write to {{.TargetFileName}} in {{.TargetDir}}"

# File context
# deny_message = "Cannot {{.Tool}} {{.FileName}} — protected"

# Environment variables
# message = "Outside {{.ProjectRoot}} — blocked"

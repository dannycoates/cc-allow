# cc-allow Global Configuration Example
# Place at: ~/.config/cc-allow.toml
#
# This provides sensible defaults for common *nix commands and coreutils.
# Project-level configs can add stricter rules on top of this.

version = "1.0"

[policy]
default = "ask"                    # defer unmatched commands to Claude Code
dynamic_commands = "ask"           # $VAR or $(cmd) as command names
default_message = "Command not in allow list"
# allowed_paths = ["/usr/bin", "/bin", "/usr/local/bin"]  # optional: restrict command search paths
unresolved_commands = "ask"        # "ask" or "deny" for commands not found in PATH

# ============================================================================
# ALIASES
# ============================================================================
# Define reusable pattern aliases to reduce repetition

[aliases]
project = "path:$PROJECT_ROOT/**"
plugin = "path:$CLAUDE_PLUGIN_ROOT/**"
sensitive-read = ["path:$HOME/.ssh/**", "path:**/*.key", "path:**/*.pem"]
sensitive-write = [
    "path:$HOME/.*",
    "path:/etc/**",
    "path:/usr/**",
    "path:/bin/**",
    "path:/sbin/**",
    "path:/lib/**",
    "path:/lib64/**",
    "path:/var/**",
    "path:/boot/**",
    "path:/root/**",
]

# ============================================================================
# FILE PERMISSIONS (Read, Edit, Write)
# ============================================================================
# Control Claude Code's Read, Edit, and Write file tools.
# Also controls bash commands that access files and redirects.
# Evaluation order: deny -> allow -> default (deny always wins)

[files]
default = "ask"  # defer to Claude Code when no rules match

[files.read]
allow = ["alias:project", "alias:plugin"]
deny = ["alias:sensitive-read"]
message = "Cannot read {{.FileName}} - sensitive file"

[files.edit]
allow = ["alias:project"]
deny = ["path:$HOME/.*"]
message = "Cannot edit {{.FileName}} - sensitive file"

# Also applies to output redirects (>, >>) when redirects.respect_file_rules = true
[files.write]
allow = ["alias:project"]
deny = ["alias:sensitive-write"]
message = "Cannot write to {{.FilePath}} - system directory"

# ============================================================================
# REDIRECTS
# ============================================================================
# Redirects respect file rules - output redirects (>, >>) check Write rules,
# input redirects (<) check Read rules.

[redirects]
respect_file_rules = true

[[redirect]]
action = "allow"
[redirect.to]
exact = ["/dev/null"]

# ============================================================================
# ALLOWED COMMANDS
# ============================================================================
# These are generally safe read-only or low-risk commands.
# Note: Dangerous variations (like rm -rf) are blocked by specific rules below.
#
# Command names can use path: prefix to match by resolved filesystem path:
#   "path:$PROJECT_ROOT/bin/*"      - allow project-local binaries
#   "path:$CLAUDE_PLUGIN_ROOT/**"   - allow plugin/skill-local binaries
#   "path:/usr/bin/git"             - allow git only from /usr/bin

[allow]
commands = [
    # -------------------------------------------------------------------------
    # Plugin/Skill Binaries
    # -------------------------------------------------------------------------
    "path:$CLAUDE_PLUGIN_ROOT/**",  # allow binaries from loaded skill/plugin

    # -------------------------------------------------------------------------
    # File & Directory Navigation
    # -------------------------------------------------------------------------
    "ls", "dir", "vdir",           # list directory contents
    "pwd",                          # print working directory
    "tree",                         # directory tree view
    "file",                         # determine file type
    "stat",                         # file/filesystem status
    "basename", "dirname",          # path component extraction
    "realpath", "readlink",         # resolve paths and symlinks

    # -------------------------------------------------------------------------
    # File Viewing & Reading
    # -------------------------------------------------------------------------
    "cat", "tac",                   # concatenate/reverse files
    "head", "tail",                 # first/last lines
    "less", "more",                 # pagers
    "nl",                           # number lines
    "od", "hexdump", "xxd",         # binary/hex viewers

    # -------------------------------------------------------------------------
    # Text Processing & Transformation
    # -------------------------------------------------------------------------
    "grep", "egrep", "fgrep",       # pattern matching
    "sed", "awk", "gawk",           # stream editing (output only, not in-place)
    "cut", "paste", "join",         # column operations
    "sort", "uniq", "shuf",         # line ordering/filtering
    "tr", "rev",                    # character translation
    "expand", "unexpand",           # tab/space conversion
    "fold", "fmt",                  # line wrapping
    "column",                       # columnate output
    "pr",                           # paginate for printing
    "wc",                           # word/line/byte count
    "comm", "diff", "cmp", "colordiff", "delta",  # comparison
    "iconv",                        # character encoding conversion
    "strings",                      # extract printable strings

    # -------------------------------------------------------------------------
    # Searching & Finding
    # -------------------------------------------------------------------------
    "find",                         # find files
    "fd",                           # modern find alternative
    "locate", "mlocate", "plocate", # locate files in database
    "which", "whereis", "type",     # locate commands
    "xargs",                        # build commands from stdin
    "rg", "ripgrep",                # ripgrep
    "ag",                           # silver searcher
    "fzf",                          # fuzzy finder

    # -------------------------------------------------------------------------
    # File Operations (Non-Destructive)
    # -------------------------------------------------------------------------
    "cp",                           # copy files
    "mv",                           # move/rename files
    "touch",                        # create/update timestamps
    "mkdir",                        # create directories
    "ln",                           # create links
    "install",                      # copy and set attributes

    # -------------------------------------------------------------------------
    # Archive & Compression
    # -------------------------------------------------------------------------
    "tar",                          # archive files
    "gzip", "gunzip", "zcat",       # gzip compression
    "bzip2", "bunzip2", "bzcat",    # bzip2 compression
    "xz", "unxz", "xzcat",          # xz compression
    "zstd", "unzstd", "zstdcat",    # zstd compression
    "zip", "unzip",                 # zip archives
    "7z", "7za", "7zr",             # 7-zip
    "rar", "unrar",                 # rar archives

    # -------------------------------------------------------------------------
    # Printing & Output
    # -------------------------------------------------------------------------
    "echo", "printf",               # print text
    "yes",                          # repeated output
    "seq",                          # number sequences
    "tee",                          # pipe to file and stdout

    # -------------------------------------------------------------------------
    # Date, Time & Calculation
    # -------------------------------------------------------------------------
    "date",                         # date/time display
    "cal", "ncal",                  # calendar
    "time",                         # time command execution
    "bc", "dc",                     # calculators
    "expr",                         # expression evaluation
    "factor",                       # factorize numbers

    # -------------------------------------------------------------------------
    # User & System Info (Read-Only)
    # -------------------------------------------------------------------------
    "whoami",                       # current user
    "id",                           # user/group IDs
    "groups",                       # group memberships
    "who", "w",                     # logged in users
    "users",                        # list users
    "last", "lastlog",              # login history
    "finger",                       # user info
    "uname",                        # system info
    "hostname",                     # system hostname
    "hostnamectl",                  # hostname info (read-only)
    "uptime",                       # system uptime
    "arch",                         # machine architecture
    "nproc",                        # number of processors
    "lscpu",                        # CPU info
    "lsmem",                        # memory info
    "free",                         # memory usage
    "df",                           # disk space
    "du",                           # directory sizes
    "lsblk",                        # block devices
    "lsusb",                        # USB devices
    "lspci",                        # PCI devices
    "lsof",                         # open files
    "dmesg",                        # kernel messages

    # -------------------------------------------------------------------------
    # Process Inspection (Read-Only)
    # -------------------------------------------------------------------------
    "ps",                           # process status
    "top",                          # process monitors
    "pgrep", "pidof",               # find process IDs
    "pstree",                       # process tree
    "jobs",                         # job control (built-in)
    "nice", "renice",               # priority (viewing)

    # -------------------------------------------------------------------------
    # Network Inspection (Read-Only)
    # -------------------------------------------------------------------------
    "ping", "ping6",                # network connectivity
    "traceroute", "tracepath",      # route tracing
    "mtr",                          # network diagnostic
    "dig", "nslookup", "host",      # DNS lookup
    "whois",                        # domain info
    "ip",                           # network config (read-only)
    "ifconfig",                     # legacy network config
    "ss", "netstat",                # socket/network stats
    "nc", "netcat",                 # network utility
    "nmap",                         # network scanner
    "tcpdump",                      # packet capture

    # -------------------------------------------------------------------------
    # Shell Builtins & Utilities
    # -------------------------------------------------------------------------
    "test", "[", "[[",              # conditionals
    "true", "false",                # exit status
    "sleep",                        # delay
    "env", "printenv",              # environment

    # -------------------------------------------------------------------------
    # Version Control
    # -------------------------------------------------------------------------
    "git",                          # git
    "gh",                           # GitHub CLI
    "hg",                           # mercurial
    "svn",                          # subversion
    "fossil",                       # fossil

    # -------------------------------------------------------------------------
    # Misc Utilities
    # -------------------------------------------------------------------------
    "man", "info", "help",          # documentation
    "apropos", "whatis",            # command lookup
    "tldr",                         # simplified man pages
    "watch",                        # repeated execution
    "timeout",                      # run with time limit
    "strace", "ltrace",             # syscall/library tracing
    "md5sum", "sha1sum", "sha256sum", "sha512sum",  # checksums
    "base64",                       # base64 encoding
    "nix", "nix-env", "nix-shell",  # Nix
]

# ============================================================================
# DENIED COMMANDS
# ============================================================================
# These commands are categorically dangerous and should never run automatically.

[deny]
commands = [
    # Privilege escalation
    "sudo", "su", "doas", "pkexec",
    # Disk/filesystem operations
    "dd", "mkfs", "fdisk", "parted", "gdisk", "cfdisk", "sfdisk",
    "mkswap", "swapon", "swapoff",
    "mount", "umount",
    "losetup",
    "lvm", "pvcreate", "vgcreate", "lvcreate",
    # System control
    "shutdown", "reboot", "halt", "poweroff", "init", "telinit",
    # User/group management
    "useradd", "userdel", "usermod",
    "groupadd", "groupdel", "groupmod",
    "passwd", "chpasswd",
    "chsh", "chfn",
    # Mass process control
    "killall", "pkill",
    # Dangerous network
    "iptables", "ip6tables", "nft", "firewall-cmd",
    "route",                        # modify routing
    # System modification
    "sysctl",
    "modprobe", "insmod", "rmmod",  # kernel modules
    "update-grub", "grub-install",
]
message = "{{.Command}} blocked - dangerous system command"

# ============================================================================
# SHELL CONSTRUCTS
# ============================================================================

[constructs]
function_definitions = "deny"      # prevent command shadowing
background = "ask"                 # background jobs need review
subshells = "ask"                  # subshells need review
heredocs = "allow"                 # heredocs are generally safe

# ============================================================================
# SPECIFIC RULES
# ============================================================================
# Fine-grained control for commands that are generally safe but have
# dangerous modes.

# --- systemctl: Allow status checks ---
[[allow.systemctl.status]]

# --- rm: Allow recursive deletion within project ---
[[allow.rm]]
args.any_match = ["flags:r", "--recursive"]
args.all_match = ["alias:project"]

# --- rm: Block recursive deletion outside project ---
[[deny.rm]]
message = "{{.ArgsStr}} - recursive deletion only allowed within project"
args.any_match = ["flags:r", "--recursive"]

# --- rm: Allow non-recursive rm within project ---
[[allow.rm]]
args.any_match = ["alias:project"]

# --- rm: Ask for non-recursive rm outside project ---
[[ask.rm]]
message = "{{.ArgsStr}} - deleting files outside project"

# --- rmdir: Allow (only removes empty directories) ---
[[allow.rmdir]]

# --- chmod: Block making files executable ---
[[ask.chmod]]
message = "{{.ArgsStr}} - making files executable requires review"
args.any_match = ["re:\\+x", "re:[0-7][1357][0-7]", "re:[0-7][0-7][1357]"]

# --- chmod: Allow other chmod operations ---
[[allow.chmod]]

# --- chown/chgrp: Always ask (ownership changes are sensitive) ---
[[ask.chown]]

[[ask.chgrp]]

# --- git: Block force push ---
[[deny.git.push]]
message = "{{.ArgsStr}} - force push not allowed"
args.any_match = ["--force", "flags:f", "--force-with-lease"]

# --- git: Block hard reset ---
[[ask.git.reset]]
message = "{{.ArgsStr}} - hard reset may lose work"
args.contains = ["--hard"]

# --- git: Block clean -f (force delete untracked files) ---
[[ask.git.clean]]
message = "{{.ArgsStr}} - git clean requires review"
args.any_match = ["flags:f", "--force"]

# --- sed/awk: Block in-place editing ---
[[deny.sed]]
message = "{{.ArgsStr}} - in-place editing not allowed, use Edit tool"
args.any_match = ["flags:i", "--in-place"]

[[deny.awk]]
message = "{{.ArgsStr}} - in-place editing not allowed, use Edit tool"
args.any_match = ["flags:i"]

# --- curl/wget: Block piping to shell ---
[[deny.bash]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} - piping to shell not allowed"
pipe.from = ["curl", "wget", "http"]

[[deny.sh]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} - piping to shell not allowed"
pipe.from = ["curl", "wget", "http"]

[[deny.zsh]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} - piping to shell not allowed"
pipe.from = ["curl", "wget", "http"]

# --- docker/podman: Block privileged containers ---
[[deny.docker]]
message = "{{.ArgsStr}} - privileged containers not allowed"
args.any_match = ["--privileged"]

[[deny.podman]]
message = "{{.ArgsStr}} - privileged containers not allowed"
args.any_match = ["--privileged"]

# --- ssh: Block with -o options that could be dangerous ---
[[ask.ssh]]
args.any_match = ["flags:o"]

# --- Example: Allow project-local scripts by resolved path ---
# [[allow."path:$PROJECT_ROOT/scripts/*"]]

# --- Example: Deny commands from untrusted directories ---
# [[deny."path:/tmp/**"]]
# message = "Commands from /tmp not allowed"

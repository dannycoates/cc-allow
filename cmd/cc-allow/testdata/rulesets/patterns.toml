# Patterns ruleset - tests advanced pattern features
# Used to verify: negation, path patterns, positional args, specificity, heredocs, pipe wildcards

version = "1.0"

[policy]
default = "ask"
dynamic_commands = "deny"

# ============================================================================
# PATH ALIASES
# ============================================================================

[paths]
project = "path:$PROJECT_ROOT/**"
etc = "path:/etc/**"

# ============================================================================
# ALLOWED COMMANDS
# ============================================================================

[allow]
commands = ["echo", "ls", "cat", "head", "tail", "grep", "wc", "pwd", "true", "false"]

# ============================================================================
# DENIED COMMANDS
# ============================================================================

[deny]
commands = ["sudo", "su"]
message = "Privilege escalation denied"

# ============================================================================
# SHELL CONSTRUCTS
# ============================================================================

[constructs]
function_definitions = "ask"
background = "ask"
subshells = "allow"
heredocs = "allow"  # allow heredocs so we can test [[heredoc]] rules

# ============================================================================
# PATTERN NEGATION TESTS
# ============================================================================

# Allow cat for any file EXCEPT those in /etc
[[allow.cat]]
args.any_match = ["!path:/etc/**"]

# Deny cat for /etc files (more specific - should win over above)
[[deny.cat]]
message = "Cannot read system config files"
args.any_match = ["path:/etc/**"]

# Deny grep when pattern looks like password
[[deny.grep]]
message = "Cannot grep for password patterns"
args.any_match = ["re:(?i)password|secret|token"]

# ============================================================================
# PATH PATTERN TESTS WITH $PROJECT_ROOT
# ============================================================================

# Allow rm only within project (safe cleanup)
[[allow.rm]]
message = "Allowed: removing files within project"
args.all_match = ["alias:project"]

# Deny rm outside project
[[deny.rm]]
message = "Cannot remove files outside project"

# Allow touch within project
[[allow.touch]]
args.any_match = ["alias:project"]

# Deny touch outside project
[[deny.touch]]
message = "Cannot create files outside project"

# ============================================================================
# POSITIONAL ARGUMENT TESTS
# ============================================================================

# Allow git with specific subcommands at position 0
[[allow.git.status]]

[[allow.git.diff]]

[[allow.git.log]]

[[allow.git.branch]]

# Deny git push/pull (network operations)
[[deny.git]]
message = "Network git operations not allowed"
args.position = { "0" = "re:^(push|pull|fetch|clone)$" }

# Allow npm with read-only commands
[[allow.npm]]
args.position = { "0" = "re:^(list|ls|view|info|help)$" }

# Deny npm install/publish (modifying operations)
[[deny.npm]]
message = "npm modifying operations not allowed"
args.position = { "0" = "re:^(install|i|publish|unpublish)$" }

# ============================================================================
# SPECIFICITY TESTS
# More specific rules should win over less specific
# ============================================================================

# Generic: any command writing to .env files - ask
[[ask."path:*"]]
message = "Writing to .env requires approval"
args.any_match = ["path:*.env", "path:.env*"]

# Specific: cp to .env - deny (more specific due to named command)
[[deny.cp]]
message = "Cannot copy to .env files"
args.any_match = ["path:*.env", "path:.env*"]

# Very specific: mv with exact positions - allow (most specific)
[[allow.mv]]
message = "Renaming .env.example to .env.local is allowed"
args.position = { "0" = ".env.example", "1" = ".env.local" }

# Less specific mv to .env - deny
[[deny.mv]]
message = "Cannot move files to .env"
args.any_match = ["path:*.env", "path:.env*"]

# ============================================================================
# PIPE WILDCARD TESTS
# ============================================================================

# Deny eval receiving ANY piped input
[[deny.eval]]
message = "eval cannot receive piped input"
pipe.from = ["path:*"]

# Deny source/. receiving any piped input
[[deny.source]]
message = "source cannot receive piped input"
pipe.from = ["path:*"]

# Deny bash from specific dangerous sources
[[deny.bash]]
message = "bash cannot receive input from download commands"
pipe.from = ["curl", "wget", "nc", "netcat"]

# ============================================================================
# HEREDOC CONTENT RULES
# ============================================================================

# Deny heredocs containing sudo/su commands
[[heredoc]]
action = "deny"
message = "Heredoc contains privilege escalation"
content_match = ["re:(?m)^\\s*(sudo|su)\\s"]

# Deny heredocs that look like they're setting up reverse shells
[[heredoc]]
action = "deny"
message = "Heredoc contains suspicious network code"
content_match = ["re:/dev/tcp/", "re:nc\\s+-e", "re:bash\\s+-i"]

# Deny heredocs containing rm -rf
[[heredoc]]
action = "deny"
message = "Heredoc contains dangerous rm command"
content_match = ["re:rm\\s+(-[rf]+\\s+)*(-[rf]+|/)"]

# ============================================================================
# REDIRECT RULES
# ============================================================================

# Deny redirects to system paths
[[redirect]]
action = "deny"
message = "Cannot write to system paths"
[redirect.to]
pattern = ["path:/etc/**", "path:/usr/**", "path:/bin/**", "path:/sbin/**"]

# Allow redirects within project
[[redirect]]
action = "allow"
[redirect.to]
pattern = ["alias:project"]

# Deny append to shell config files
[[redirect]]
action = "deny"
message = "Cannot modify shell config"
append = true
[redirect.to]
pattern = ["path:*/.bashrc", "path:*/.zshrc", "path:*/.profile"]

# ============================================================================
# FLAG PATTERN TESTS
# ============================================================================

# Deny chmod with executable bits using flag pattern
# flags[+]:x matches +x, +rx, +rwx etc.
[[deny.chmod]]
message = "Cannot make files executable"
args.any_match = ["flags[+]:x"]

# Allow chmod without executable bits (including -x to remove)
[[allow.chmod]]

# Deny tar with extract and overwrite using flag pattern
[[deny.tar]]
message = "Cannot extract with overwrite"
args.any_match = ["flags:xf"]

# Allow tar for listing and creation
[[allow.tar]]
args.any_match = ["flags:t", "flags:c"]

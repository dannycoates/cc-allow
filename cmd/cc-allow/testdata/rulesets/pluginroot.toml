# Pluginroot ruleset - tests $CLAUDE_PLUGIN_ROOT variable expansion
# Used to verify skills/plugins can restrict commands to their own directories

[policy]
default = "deny"
dynamic_commands = "deny"

[commands.allow]
names = ["echo", "ls", "cat", "pwd"]

[commands.deny]
names = ["sudo", "su"]
message = "Privilege escalation denied"

[constructs]
function_definitions = "deny"
background = "deny"
heredocs = "allow"

# --- Plugin Root Path Tests ---

# Allow read commands within plugin root
[[rule]]
command = "cat"
action = "allow"
message = "Allowed: reading files within plugin"
[rule.args]
all_match = ["path:$CLAUDE_PLUGIN_ROOT/**"]

# Deny cat outside plugin root (more specific due to path pattern)
[[rule]]
command = "cat"
action = "deny"
message = "Cannot read files outside plugin directory"
[rule.args]
any_match = ["!path:$CLAUDE_PLUGIN_ROOT/**"]

# Allow script execution within plugin
[[rule]]
command = "bash"
action = "allow"
message = "Allowed: running scripts within plugin"
[rule.args]
position = { "0" = "path:$CLAUDE_PLUGIN_ROOT/**" }

# Deny bash scripts outside plugin
[[rule]]
command = "bash"
action = "deny"
message = "Cannot run scripts outside plugin directory"

# Allow touch within plugin root
[[rule]]
command = "touch"
action = "allow"
[rule.args]
all_match = ["path:$CLAUDE_PLUGIN_ROOT/**"]

# Deny touch outside plugin root
[[rule]]
command = "touch"
action = "deny"
message = "Cannot create files outside plugin directory"

# Allow rm within plugin root only
[[rule]]
command = "rm"
action = "allow"
message = "Allowed: removing files within plugin"
[rule.args]
all_match = ["path:$CLAUDE_PLUGIN_ROOT/**"]

# Deny rm outside plugin root
[[rule]]
command = "rm"
action = "deny"
message = "Cannot remove files outside plugin directory"

# --- Redirect Rules for Plugin Root ---

# Allow redirects within plugin root
[[redirect]]
action = "allow"
[redirect.to]
pattern = ["path:$CLAUDE_PLUGIN_ROOT/**"]

# Deny redirects outside plugin root
[[redirect]]
action = "deny"
message = "Cannot write files outside plugin directory"
